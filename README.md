# Masters Radio - Top 100 Rankings System

Automated monthly Spotify-based ranking system for Masters Radio's music catalog.

## Overview

This application scans WordPress uploads for MP3 files, matches them to Spotify tracks, captures popularity scores, and generates a Top 100 ranking CSV report delivered via email.

**Runs automatically:** Last Monday of each month at 04:00 America/New_York

## Features

- **Automatic MP3 Discovery**: Scans WordPress uploads directory recursively
- **Intelligent Matching**: Uses ISRC codes and aggressive string normalization for high match rates
- **Spotify Integration**: Retrieves real-time popularity scores (0-100)
- **Multi-Level Ranking**: Sophisticated tie-breaking algorithm
- **Email Delivery**: Automated reports with CSV attachment
- **Historical Tracking**: Full database of all tracks and monthly performance
- **Rate Limiting**: Respects Spotify API limits with exponential backoff

## Requirements

- PHP 8.0+ (tested on 8.3.6)
- MySQL 5.7+ or MariaDB 10.3+
- Composer
- Required PHP extensions: curl, json, mbstring, pdo, pdo_mysql

## Installation

1. **Clone repository:**
   ```bash
   cd /opt
   git clone https://github.com/appressman/MR-Top100-Ranking.git top100
   cd top100
   ```

2. **Install dependencies:**
   ```bash
   php composer.phar install --no-dev --optimize-autoloader
   ```

3. **Run installer:**
   ```bash
   php install.php
   ```

4. **Configure environment:**
   Edit `.env` and set required values:
   - `WP_ROOT` - WordPress installation path
   - `SPOTIFY_CLIENT_ID` - From Spotify Developer Dashboard
   - `SPOTIFY_CLIENT_SECRET` - From Spotify Developer Dashboard
   - `GMAIL_OAUTH_CLIENT_ID` - From Google Cloud Console
   - `GMAIL_OAUTH_CLIENT_SECRET` - From Google Cloud Console
   - `GMAIL_OAUTH_REFRESH_TOKEN` - Generated by setup script
   - `REPORT_TO_EMAIL` - Recipient email address

5. **Test connectivity:**
   ```bash
   php scripts/test_spotify.php
   ```

6. **Run test:**
   ```bash
   php Top100Rankings.php --run-now --dry-run --limit=10 --verbose
   ```

7. **Schedule cron:**
   ```bash
   crontab -e
   # Add:
   0 4 * * 1 /usr/bin/php /opt/top100/Top100Rankings.php --cron >> /opt/top100/logs/cron.log 2>&1
   ```

## Usage

### Command Line Options

```bash
php Top100Rankings.php [OPTIONS]

Options:
  --cron              Run in cron mode (exit unless last Monday)
  --run-now           Bypass schedule gate
  --month=YYYY-MM     Force specific label month
  --dry-run           Test mode (no DB writes or emails)
  --verbose           Detailed DEBUG logging
  --limit=N           Process only N files
  --help              Show help
  --version           Show version
```

### Examples

**Manual run:**
```bash
php Top100Rankings.php --run-now --verbose
```

**Test with limited files:**
```bash
php Top100Rankings.php --run-now --dry-run --limit=20 --verbose
```

**Rerun specific month:**
```bash
php Top100Rankings.php --run-now --month=2025-11
```

## Project Structure

```
/opt/top100/
├── Top100Rankings.php          # Main CLI entry point
├── install.php                 # Installation script
├── composer.json               # Dependencies
├── .env                        # Configuration (not in Git)
├── src/                        # Application code
│   ├── Config.php
│   ├── Logger.php
│   ├── Database/               # Database layer
│   ├── WordPress/              # WordPress integration
│   ├── Metadata/               # ID3 tag extraction
│   ├── Spotify/                # Spotify API client
│   ├── Ranking/                # Ranking engine & CSV
│   ├── Email/                  # Email delivery
│   └── Scheduling/             # Cron gate & locking
├── config/
│   ├── .env.example
│   └── schema/migrations/      # Database migrations
├── scripts/                    # Utility scripts
│   └── test_spotify.php
├── reports/                    # Generated CSV files
│   └── YYYY-MM/
└── logs/                       # Execution logs
    └── YYYY-MM.log
```

## Database Schema

- **tracks** - Canonical track identities (deduped by Spotify ID)
- **wp_media** - WordPress MP3 file inventory
- **runs** - Monthly execution metadata
- **observations** - Historical snapshots of all tracks per run
- **rankings** - Top 100 for each run (denormalized)
- **overrides** - Manual match corrections (future)

## Output

**CSV Format:** UTF-8 with BOM, Excel-compatible

**Columns:**
- rank
- artist
- title
- isrc
- spotify_id
- popularity
- release_date
- wp_media_id
- source_url

**Location:** `/opt/top100/reports/YYYY-MM/Top100_YYYY-MM.csv`

## Troubleshooting

**Check logs:**
```bash
tail -f /opt/top100/logs/$(date +%Y-%m).log
```

**Verify schedule:**
```bash
php -r "
\$tz = new DateTimeZone('America/New_York');
\$now = new DateTime('now', \$tz);
\$lastDay = new DateTime('last day of this month', \$tz);
while (\$lastDay->format('N') != 1) \$lastDay->modify('-1 day');
echo 'Next run: ' . \$lastDay->setTime(4,0)->format('Y-m-d H:i T') . \"\n\";
"
```

**Test database connection:**
```bash
php -r "
require 'vendor/autoload.php';
use MastersRadio\Top100\Config;
use MastersRadio\Top100\Database\Connection;
use MastersRadio\Top100\WordPress\ConfigReader;
\$config = new Config(__DIR__);
\$wpConfig = new ConfigReader(\$config->get('WP_ROOT'));
\$db = Connection::getInstance(
    \$wpConfig->getDbHost(),
    \$config->get('DB_NAME'),
    \$wpConfig->getDbUser(),
    \$wpConfig->getDbPassword()
);
echo 'Database connected: ' . \$config->get('DB_NAME') . \"\n\";
"
```

## Development

**Run with verbose logging:**
```bash
php Top100Rankings.php --run-now --dry-run --verbose | tee test.log
```

**Check syntax:**
```bash
find src -name "*.php" -exec php -l {} \;
```

## License

Proprietary - Masters Radio

## Support

For issues or questions, contact: adam.pressman@mastersradio.com

## Version

1.0.0 (Initial Release - November 2025)
